<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getDatabase, ref, push, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCm5cGoc9TIyj2S0XDK-_nvhhUhCCAPiHM",
    authDomain: "worldly-speech.firebaseapp.com",
    databaseURL: "https://worldly-speech-default-rtdb.firebaseio.com",
    projectId: "worldly-speech",
    storageBucket: "worldly-speech.firebasestorage.app",
    messagingSenderId: "1028112726226",
    appId: "1:1028112726226:web:fb7c9091665459e61b550b",
    measurementId: "G-MR9Z2PD162"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getDatabase();

  const authDiv = document.getElementById("auth");
  const forumDiv = document.getElementById("forum");
  const postInput = document.getElementById("post");
  const postsList = document.getElementById("posts");

  // ADMIN EMAIL
  const adminEmail = "marketingkagency@gmail.com";
  let currentUserEmail = "";

  // Register new user
  window.register = () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    createUserWithEmailAndPassword(auth, email, password)
      .then(() => showForum())
      .catch(e => alert(e.message));
  };

  // Login user
  window.login = () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    signInWithEmailAndPassword(auth, email, password)
      .then(() => showForum())
      .catch(e => alert(e.message));
  };

  // Show forum after login
  function showForum() {
    authDiv.style.display = "none";
    forumDiv.style.display = "block";
  }

  // Logout user
  window.logout = () => {
    signOut(auth).then(() => {
      authDiv.style.display = "block";
      forumDiv.style.display = "none";
    });
  };

  // Track current logged-in user
  onAuthStateChanged(auth, (user) => {
    if (user) currentUserEmail = user.email;
    else currentUserEmail = "";
  });

  // Add a post
  window.addPost = () => {
    const text = postInput.value.trim();
    if (!text) return;

    push(ref(db, "posts"), { text, time: Date.now(), author: currentUserEmail });
    postInput.value = "";
  };

  // Display posts in real-time
  onChildAdded(ref(db, "posts"), (snapshot) => {
    const msg = snapshot.val();
    const li = document.createElement("li");
    li.textContent = msg.text;

    // Highlight Admin posts
    if (msg.author === adminEmail) {
      li.style.borderLeft = "4px solid gold";
      li.style.backgroundColor = "#fff8dc";
      li.style.padding = "10px";
    }

    // Add Delete button for Admin
    if (currentUserEmail === adminEmail) {
      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete";
      delBtn.style.float = "right";
      delBtn.onclick = () => {
        remove(ref(db, "posts/" + snapshot.key));
      };
      li.appendChild(delBtn);
    }

    postsList.appendChild(li);
  });
</script>
